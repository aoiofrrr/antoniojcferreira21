{% extends "base.html" %}

{% block title %}{{ project.name }} - Growth Hacking Manager{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h2>{{ project.name }}</h2>
        <span class="status-badge status-{{ project.status }}">{{ project.status }}</span>
    </div>
    <div class="header-actions">
        <a href="{{ url_for('edit_project', project_id=project.id) }}" class="btn-secondary">Edit Project</a>
        <a href="{{ url_for('index') }}" class="btn-secondary">Back to Dashboard</a>
    </div>
</div>

<div class="project-details">
    {% if project.description %}
    <div class="detail-section">
        <h3>Description</h3>
        <p>{{ project.description }}</p>
    </div>
    {% endif %}

    {% if project.goal %}
    <div class="detail-section">
        <h3>Goal</h3>
        <p>{{ project.goal }}</p>
    </div>
    {% endif %}

    {% if project.target_metric and project.target_value %}
    <div class="detail-section">
        <h3>Target</h3>
        <p><strong>{{ project.target_metric }}</strong> = {{ project.target_value }}</p>
    </div>
    {% endif %}

    <div class="detail-section">
        <h3>Timeline</h3>
        <p>Created: {{ project.created_at[:10] }} | Updated: {{ project.updated_at[:10] }}</p>
    </div>
</div>

<div class="two-column-layout">
    <div class="column">
        <div class="card">
            <h3>Add Metric</h3>
            <form method="POST" action="{{ url_for('add_metric', project_id=project.id) }}" class="metric-form">
                <div class="form-group">
                    <label for="metric_name">Metric Name</label>
                    <input type="text" id="metric_name" name="metric_name" required
                           placeholder="e.g., users, conversions, revenue"
                           list="metric-suggestions">
                    <datalist id="metric-suggestions">
                        {% for name in metric_names %}
                        <option value="{{ name }}">
                        {% endfor %}
                    </datalist>
                </div>

                <div class="form-group">
                    <label for="value">Value</label>
                    <input type="number" id="value" name="value" step="0.01" required
                           placeholder="e.g., 1250">
                </div>

                <div class="form-group">
                    <label for="note">Note (optional)</label>
                    <input type="text" id="note" name="note"
                           placeholder="e.g., After feature launch">
                </div>

                <div class="form-group">
                    <label for="date">Date (optional)</label>
                    <input type="date" id="date" name="date">
                </div>

                <button type="submit" class="btn-primary">Add Metric</button>
            </form>
        </div>

        <div class="card">
            <h3>Add Note</h3>
            <form method="POST" action="{{ url_for('add_note', project_id=project.id) }}">
                <div class="form-group">
                    <textarea name="note" rows="3" required
                              placeholder="Document insights, changes, or observations..."></textarea>
                </div>
                <button type="submit" class="btn-primary">Add Note</button>
            </form>
        </div>
    </div>

    <div class="column">
        {% if growth_data %}
        <div class="card">
            <h3>Growth Analysis</h3>
            {% for metric_name, growth in growth_data.items() %}
            <div class="growth-item">
                <h4>{{ metric_name }}</h4>
                <div class="growth-stats">
                    <div class="growth-stat">
                        <span class="label">Start:</span>
                        <span class="value">{{ growth.start_value }}</span>
                    </div>
                    <div class="growth-stat">
                        <span class="label">Current:</span>
                        <span class="value">{{ growth.end_value }}</span>
                    </div>
                    <div class="growth-stat">
                        <span class="label">Growth:</span>
                        <span class="value growth-rate {% if growth.growth_rate > 0 %}positive{% elif growth.growth_rate < 0 %}negative{% endif %}">
                            {{ "%.2f"|format(growth.growth_rate) }}%
                        </span>
                    </div>
                    <div class="growth-stat">
                        <span class="label">Absolute:</span>
                        <span class="value">{{ "%.2f"|format(growth.absolute_growth) }}</span>
                    </div>
                </div>
                <div class="growth-period">
                    {{ growth.start_date[:10] }} â†’ {{ growth.end_date[:10] }}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if project.notes %}
        <div class="card">
            <h3>Recent Notes</h3>
            <div class="notes-list">
                {% for note in project.notes[-5:]|reverse %}
                <div class="note-item">
                    <div class="note-date">{{ note.date[:10] }}</div>
                    <div class="note-text">{{ note.note }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if metric_names %}
<div class="metrics-section">
    <h3>Metrics Visualization</h3>
    <div class="chart-controls">
        <label for="chart-metric">Select Metric:</label>
        <select id="chart-metric" onchange="updateChart()">
            {% for name in metric_names %}
            <option value="{{ name }}">{{ name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="chart-container">
        <canvas id="metricsChart"></canvas>
    </div>
</div>

<script>
let chart = null;
const projectId = "{{ project.id }}";

async function updateChart() {
    const metricName = document.getElementById('chart-metric').value;
    const response = await fetch(`/api/project/${projectId}/metrics/${metricName}`);
    const data = await response.json();

    const ctx = document.getElementById('metricsChart').getContext('2d');

    if (chart) {
        chart.destroy();
    }

    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [{
                label: metricName,
                data: data.values,
                borderColor: '#4F46E5',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const note = data.notes[context.dataIndex];
                            return note ? `Note: ${note}` : '';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });
}

// Load chart on page load
document.addEventListener('DOMContentLoaded', updateChart);
</script>
{% endif %}

{% if project.metrics %}
<div class="metrics-table-section">
    <h3>All Metrics</h3>
    <table class="metrics-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Metric</th>
                <th>Value</th>
                <th>Note</th>
            </tr>
        </thead>
        <tbody>
            {% for metric in project.metrics|reverse %}
            <tr>
                <td>{{ metric.date[:10] }}</td>
                <td>{{ metric.name }}</td>
                <td>{{ metric.value }}</td>
                <td>{{ metric.note }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="empty-state">
    <div class="empty-icon">ðŸ“ˆ</div>
    <h3>No metrics yet</h3>
    <p>Start tracking by adding your first metric</p>
</div>
{% endif %}

<div class="danger-zone">
    <h3>Danger Zone</h3>
    <form method="POST" action="{{ url_for('delete_project', project_id=project.id) }}"
          onsubmit="return confirm('Are you sure you want to delete this project? This cannot be undone.');">
        <button type="submit" class="btn-danger">Delete Project</button>
    </form>
</div>
{% endblock %}
